<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quix 3D - Print Time Estimator</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Product+Sans&display=swap"
      rel="stylesheet"
    />
    <!-- In the head section, replace the existing Three.js related scripts with these -->
    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <div class="gradient-bg"></div>
    <div class="content">
      <div class="container">
        <h2>Estimate Print Time</h2>
        <form id="estimateForm">
          <input type="file" accept=".stl" required id="stlFile" />
          <label>Quality Settings (See Advanced)</label>
          <select name="quality" required>
            <option value="">Select Quality</option>
            <option value="high" selected>High Quality (Slower)</option>
            <option value="medium">Medium Quality</option>
            <option value="low">Low Quality (Faster)</option>
          </select>
          <label>Infill Percentage</label>
          <input
            type="number"
            name="infillPercentage"
            placeholder="Infill Percentage"
            min="0"
            max="100"
            required
            value="20"
          />
          <label>Quantity</label>
          <input
            type="number"
            name="quantity"
            id="quantity"
            placeholder="Enter quantity"
            min="1"
            value="1"
            required
          />    
          <div class="discount-display">
            <label>Discount: (Depends on Quantity)</label>
            <span id="discountPercentage">0%</span>
          </div>
          <div style="display: flex; gap: 10px;">
            <button type="submit">Calculate Estimate</button>
            <button type="button" id="printerConfigBtn" style="background: linear-gradient(45deg, #4caf50, #45a049);">Printer Config</button>
        </div>
          </button>
        </form>
        <div id="result"></div>
      </div>

      <div id="stlViewer"></div>

      <div class="right-options">
        <div class="option-group">
          <div class="option-title">Spray Paint Options</div>
          <div class="option-description">
            Enhance your print with professional spray painting. Choose colors
            and add primer for better adhesion and finish quality.
          </div>
          <div class="checkbox-container">
            <input type="checkbox" id="paintOption" name="paintOption" />
            <label for="paintOption">Enable Spray Paint</label>
          </div>
          <div class="paint-options">
            <label>Paint Color</label>
            <select name="paintColor">
              <option value="golden" selected>Golden</option>
              <option value="silver">Silver</option>
              <option value="white">White</option>
              <option value="blue">Blue</option>
              <option value="red">Red</option>
              <option value="green">Green</option>
              <option value="black">Black</option>
            </select>

            <label>Number of Coats</label>
            <input type="number" name="coats" value="2" min="1" max="5" />

            <div class="checkbox-container">
              <input type="checkbox" id="primerOption" name="primerOption" />
              <label for="primerOption">Add Primer</label>
            </div>
          </div>
        </div>

        <div class="option-group">
          <div class="option-title">Advanced Print Settings</div>
          <div class="option-description">
            Fine-tune your print quality and strength with these advanced
            settings. Default values are optimized for most prints.
          </div>
          <div class="checkbox-container">
            <input type="checkbox" id="advancedOption" name="advancedOption" />
            <label for="advancedOption">Enable Advanced Options</label>
          </div>
          <div class="advanced-options">
            <label>Layer Height (mm)</label>
            <input
              type="number"
              name="layerHeight"
              value="0.2"
              step="0.01"
              min="0.1"
              max="0.4"
            />

            <label>Wall Thickness (mm)</label>
            <input
              type="number"
              name="wallThickness"
              value="0.8"
              step="0.1"
              min="0.4"
              max="2"
            />

            <label>Top/Bottom Layers</label>
            <input
              type="number"
              name="topBottomLayers"
              value="2"
              min="1"
              max="10"
            />

            <label>Print Speed (mm/s)</label>
            <input
              type="number"
              name="printSpeed"
              value="100"
              min="10"
              max="150"
            />

            <div class="checkbox-container">
              <input
                type="checkbox"
                id="supportOption"
                name="supportOption"
                checked
              />
              <label for="supportOption">Enable Support</label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let scene, camera, renderer, object, controls, animationId;

      document
        .getElementById("stlFile")
        .addEventListener("change", function (event) {
          console.log("File selected");
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              try {
                console.log("File loaded, parsing STL");
                const geometry = new THREE.STLLoader().parse(e.target.result);
                console.log("STL parsed successfully");
                displaySTL(geometry);
              } catch (error) {
                console.error("Error parsing STL file:", error);
                alert(
                  "Error parsing STL file. Please check the console for details."
                );
              }
            };
            reader.onerror = function (e) {
              console.error("Error reading file:", e);
              alert("Error reading file. Please try again.");
            };
            reader.readAsArrayBuffer(file);
          }
        });

      function resizeSTLViewer() {
        const viewer = document.getElementById("stlViewer");
        const container = viewer.querySelector("canvas");
        if (container) {
          const height = container.clientHeight;
          viewer.style.width = height + "px";
          renderer.setSize(height, height);
        }
      }

      window.addEventListener("resize", resizeSTLViewer);
      window.addEventListener("load", resizeSTLViewer);

      function formatTime(hours) {
        const h = Math.floor(hours);
        const m = Math.floor((hours - h) * 60);
        const s = Math.floor(((hours - h) * 60 - m) * 60);

        let result = [];
        if (h > 0) result.push(`${h}hr`);
        if (m > 0) result.push(`${m}min`);
        if (s > 0) result.push(`${s}sec`);
        return result.join(" ");
      }

      function displaySTL(geometry) {
        if (animationId) {
          cancelAnimationFrame(animationId);
        }

        if (!scene) {
          scene = new THREE.Scene();
          const aspect = window.innerWidth / window.innerHeight;
          camera = new THREE.OrthographicCamera(
            -10 * aspect,
            10 * aspect,
            10,
            -10,
            0.1,
            1000
          );
          renderer = new THREE.WebGLRenderer({ antialias: true });
          renderer.setSize(window.innerWidth / 2, window.innerHeight);
          renderer.setClearColor(0x000000, 0);
          document.getElementById("stlViewer").appendChild(renderer.domElement);

          controls = new THREE.OrbitControls(camera, renderer.domElement);
          if (controls) {
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = true;
            controls.minDistance = 1;
            controls.maxDistance = 500;
            controls.maxPolarAngle = Infinity; // Changed from Math.PI
            controls.minPolarAngle = -Infinity; // Changed to allow full rotation
            controls.enableRotate = true;
            controls.rotateSpeed = 0.5;
            controls.enableZoom = true;
            controls.zoomSpeed = 1.0;
            controls.enablePan = true;
            controls.panSpeed = 1.0;
            controls.minAzimuthAngle = -Infinity; // Add this for horizontal rotation
            controls.maxAzimuthAngle = Infinity; // Add this for horizontal rotation
            controls.mouseButtons = {
              LEFT: THREE.MOUSE.ROTATE,
              MIDDLE: THREE.MOUSE.DOLLY,
              RIGHT: THREE.MOUSE.PAN,
            };
          }
        }

        if (object) {
          scene.remove(object);
        }

        geometry.center();

        const material = new THREE.MeshStandardMaterial({
          color: 0x808080,
          roughness: 0.7,
          metalness: 0.1,
        });

        object = new THREE.Mesh(geometry, material);

        scene.clear();
        scene.add(object);

        object.updateMatrix();

        const box = new THREE.Box3().setFromObject(object);
        const size = box.getSize(new THREE.Vector3());
        const maxDim = Math.max(size.x, size.y, size.z);

        const zoom = 2;
        camera.left = -maxDim * zoom;
        camera.right = maxDim * zoom;
        camera.top = maxDim * zoom;
        camera.bottom = -maxDim * zoom;
        camera.near = -1000;
        camera.far = 1000;
        camera.position.set(maxDim, maxDim, maxDim);
        camera.lookAt(0, 0, 0);
        camera.updateProjectionMatrix();

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        const frontLight = new THREE.DirectionalLight(0xffffff, 0.8);
        frontLight.position.set(0, 0, 1);
        scene.add(frontLight);

        const backLight = new THREE.DirectionalLight(0xffffff, 0.3);
        backLight.position.set(0, 0, -1);
        scene.add(backLight);

        const topLight = new THREE.DirectionalLight(0xffffff, 0.3);
        topLight.position.set(0, 1, 0);
        scene.add(topLight);

        if (controls) {
          controls.target.set(0, 0, 0);
          controls.update();
        }

        function animate() {
          animationId = requestAnimationFrame(animate);
          if (controls && typeof controls.update === "function") {
            controls.update();
          }
          if (renderer && scene && camera) {
            renderer.render(scene, camera);
          }
        }

        animate();
        resizeSTLViewer();

        document.querySelector(".container").style.width = "40%";
        document.getElementById("stlViewer").style.display = "block";
      }

      // Add window resize handler
      window.addEventListener("resize", function () {
        if (camera && renderer) {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth / 2, window.innerHeight);
        }
      });

      document
        .getElementById("paintOption")
        .addEventListener("change", function (event) {
          document.querySelector(".paint-options").style.display = event.target
            .checked
            ? "block"
            : "none";
        });

      document
        .getElementById("advancedOption")
        .addEventListener("change", function (event) {
          document.querySelector(".advanced-options").style.display = event
            .target.checked
            ? "block"
            : "none";
        });

      document
        .getElementById("estimateForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const formData = new FormData(this);
          const file = document.getElementById("stlFile").files[0];

          if (!file) {
            alert("Please select an STL file");
            return;
          }

          // Get all values properly
          const values = {
            quality: formData.get("quality"),
            infill: parseFloat(formData.get("infillPercentage")) || 20,
            paintOption: document.getElementById("paintOption").checked,
            coats:
              parseInt(document.querySelector('input[name="coats"]').value) ||
              2,
            primer: document.getElementById("primerOption").checked,
            layerHeight:
              parseFloat(
                document.querySelector('input[name="layerHeight"]').value
              ) || 0.2,
            wallThickness:
              parseFloat(
                document.querySelector('input[name="wallThickness"]').value
              ) || 0.8,
            topBottomLayers:
              parseInt(
                document.querySelector('input[name="topBottomLayers"]').value
              ) || 2,
            printSpeed:
              parseFloat(
                document.querySelector('input[name="printSpeed"]').value
              ) || 100,
            support: document.getElementById("supportOption").checked,
            quantity: parseInt(document.getElementById('quantity').value) || 1
          };

          // Debug log to verify values
          console.log("Form Values:", values);

          calculateVolume(file)
            .then((volume) => {
              const result = estimateCostAndTime(
                volume,
                values.quality,
                values.infill,
                values.paintOption,
                values.coats,
                values.primer,
                values.layerHeight,
                values.wallThickness,
                values.topBottomLayers,
                values.printSpeed,
                values.support,
                values.quantity
              );

              const resultDiv = document.getElementById("result");
              resultDiv.style.display = "block";
              resultDiv.innerHTML = `
   <div style="font-size: 1.1rem; margin-bottom: 15px;">
       <b>Print Duration (per item):</b> ${formatTime(result.printTime)}
   </div>

   <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
       <div style="margin-bottom: 10px">
           <b>Base Print Cost:</b><br>
           ₹${result.printCost.min.toFixed(0)}
           <span style="color: #888"> up to ₹${result.printCost.max.toFixed(
             0
           )}</span>
       </div>

       <div style="margin-bottom: 5px">
           <b>Labor Charge:</b><br>
           ₹${(result.printCost.min * 0.2).toFixed(0)} - ${(
                result.printCost.max * 0.2
              ).toFixed(0)}
       </div>

       <div style="margin-bottom: 5px">
           <b>Machine Wear:</b><br>
           ₹${(result.printCost.min * 0.2).toFixed(0)} - ${(
                result.printCost.max * 0.2
              ).toFixed(0)}
       </div>

      <div style="margin-bottom: 5px; padding-top: 5px; border-top: 1px solid rgba(255,255,255,0.1)">
          <b>Discount (${result.discountPercentage}%):</b><br>
          ₹${result.discountAmount.min.toFixed(0)} - ₹${result.discountAmount.max.toFixed(0)}
      </div>

       <div style="margin-bottom: 5px">
           <b>GST (18%):</b><br>
           ₹${(result.printCost.min * 0.18).toFixed(0)} - ${(
                result.printCost.max * 0.18
              ).toFixed(0)}
       </div>

       <div style="margin-bottom: 5px; padding-top: 5px; border-top: 1px solid rgba(255,255,255,0.1)">
           <b>Delivery:</b><br>
           ₹${result.delivery.min} - ${result.delivery.max}
       </div>

       <div style="margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(255,255,255,0.1)">
           <b>Total Estimate:</b><br>
           Starting ₹${result.total.min.toFixed(
             0
           )} <span style="color: #888"> up to ₹${result.total.max.toFixed(
                0
              )}</span>
       </div>
   </div>
`;
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("Error calculating. Please try again.");
            });
        });

      document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("result").style.display = "none";
        document
          .getElementById("printerConfigBtn")
          .addEventListener("click", function (e) {
            e.preventDefault();
            document.getElementById("printerModal").style.display = "block";
          });

        document
          .querySelector(".close-btn")
          .addEventListener("click", function () {
            document.getElementById("printerModal").style.display = "none";
          });

        window.addEventListener("click", function (e) {
          if (e.target == document.getElementById("printerModal")) {
            document.getElementById("printerModal").style.display = "none";
          }
        });
      });

      function calculateVolume(file) {
        console.log("Calculating volume");
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const geometry = new THREE.STLLoader().parse(e.target.result);
              const volume = getVolume(geometry);
              resolve(volume);
            } catch (error) {
              reject(error);
            }
          };
          reader.onerror = reject;
          reader.readAsArrayBuffer(file);
        });
      }

      function getVolume(geometry) {
        let volume = 0;
        const positions = geometry.attributes.position.array;
        for (let i = 0; i < positions.length; i += 9) {
          const t1x = positions[i],
            t1y = positions[i + 1],
            t1z = positions[i + 2];
          const t2x = positions[i + 3],
            t2y = positions[i + 4],
            t2z = positions[i + 5];
          const t3x = positions[i + 6],
            t3y = positions[i + 7],
            t3z = positions[i + 8];
          volume += signedVolumeOfTriangle(
            t1x,
            t1y,
            t1z,
            t2x,
            t2y,
            t2z,
            t3x,
            t3y,
            t3z
          );
        }
        return Math.abs(volume) / 1000; // Convert to cm³
      }

      function signedVolumeOfTriangle(x1, y1, z1, x2, y2, z2, x3, y3, z3) {
        return (
          (1.0 / 6.0) *
          (-x3 * y2 * z1 +
            x2 * y3 * z1 +
            x3 * y1 * z2 -
            x1 * y3 * z2 -
            x2 * y1 * z3 +
            x1 * y2 * z3)
        );
      }

      function estimateCostAndTime(
        volume,
        quality,
        infillPercentage,
        paintOption,
        coats,
        primer,
        layerHeight,
        wallThickness,
        topBottomLayers,
        printSpeed,
        support,
        quantity
      ) {
        console.log("Calculation inputs:", {
          volume,
          quality,
          infillPercentage,
          paintOption,
          coats,
          primer,
          layerHeight,
          wallThickness,
          topBottomLayers,
          printSpeed,
          support,
          quantity
        });

        // Base print time calculation (in hours)
        let printTime = volume * 0.04;

        // Quality multipliers
        const qualityMultipliers = {
          high: { time: 1.2, cost: 1.15 },
          medium: { time: 1.1, cost: 1.1 },
          low: { time: 1, cost: 1 },
        };

        // Apply quality multiplier
        printTime *= qualityMultipliers[quality].time;

        // Layer height impact (0.2mm is baseline)
        printTime *= (0.2 / layerHeight) * 1.2;

        // Wall thickness impact
        printTime *= wallThickness / 0.8;

        // Top/Bottom layers impact (2 is baseline)
        printTime *= topBottomLayers / 2;

        // Speed impact - faster speed = less time
        printTime *= 100 / printSpeed;

        // Tiny inefficiency factor for very high speeds
        if (printSpeed > 100) {
          printTime *= 1 + (printSpeed - 100) * 0.001;
        }

        // Infill impact (20% is baseline)
        printTime *= 0.7 + 0.3 * (infillPercentage / 20);

        // Support structure impact
        if (support) {
          printTime *= 1.3;
        }

        // Base print cost calculation
        let basePrintCost = volume * 0.965;

        // Apply quality multiplier to cost
        let minPrintCost = basePrintCost * qualityMultipliers[quality].cost;

        // Add machine operation cost (₹3.5 per hour)
        let operationCost = printTime * 3.5;
        minPrintCost += operationCost;

        // Adjust cost based on infill
        let infillCostFactor = 1 + Math.log(infillPercentage / 20) * 0.2;
        minPrintCost *= infillCostFactor;

        // Wall thickness impact on cost
        minPrintCost *= wallThickness / 0.8;

        // Support structure cost impact
        if (support) {
          minPrintCost *= 1.15;
        }

        // Paint costs
        if (paintOption) {
          const surfaceArea = Math.pow(volume, 2 / 3) * 4.836;
          const paintCostPerCoat = Math.min(
            Math.max(surfaceArea / 10, 10),
            100
          );
          const totalPaintCost = paintCostPerCoat * coats;

          if (primer) {
            minPrintCost += 20;
          }
          minPrintCost += totalPaintCost;
        }


        let discount = 0;
        if (quantity > 25) {
          discount = 0.15;
        } else if (quantity > 10) {
          discount = 0.125;
        } else if (quantity > 3) {
          discount = 0.025;
        }

        console.log(quantity);
        console.log(discount);

        let quantityMultiplier = quantity;
        let discountMultiplier = 1 - discount;

        // Add labor charge (20% of print cost)
        let laborCharge = minPrintCost * 0.2;
        minPrintCost += laborCharge;

        // Add machine wear charge (20% of print cost)
        let wearCharge = minPrintCost * 0.2;
        minPrintCost += wearCharge;

        //Discount
        minPrintCost = minPrintCost * quantityMultiplier * discountMultiplier;

        // Calculate tax (18%) before delivery
        let minTax = minPrintCost * 0.18;
        let maxTax = minPrintCost * 1.2 * 0.18;

        // Maximum cost is 20% more than minimum
        let maxPrintCost = minPrintCost * 1.2;

        const discountAmount = {
          min: minPrintCost * discount,
          max: maxPrintCost * discount
        };

        // Delivery costs
        const delivery = { min: 60, max: 120 };

        // Calculate total (including tax)
        const total = {
          min: minPrintCost + minTax + delivery.min,
          max: maxPrintCost + maxTax + delivery.max,
        };

        console.log("Calculation results:", {
          printTime,
          printCost: { min: minPrintCost, max: maxPrintCost },
          delivery,
          total,
          laborCharge,
          wearCharge,
          operationCost,
        });

        return {
          printTime,
          printCost: { min: minPrintCost, max: maxPrintCost },
          delivery,
          total,
          discountAmount,  // Add this
          discountPercentage: discount * 100  // Add this to show percentage
        };
      }

      function addNumericValidation(inputName, min, max, defaultVal) {
        const input = document.querySelector(`input[name="${inputName}"]`);
        if (input) {
          input.addEventListener("change", function () {
            let value = parseFloat(this.value);
            if (isNaN(value) || value < min) {
              this.value = min;
            } else if (value > max) {
              this.value = max;
            }
          });
        }
      }

      // Add validations when document loads
      document.addEventListener("DOMContentLoaded", function () {
        addNumericValidation("coats", 1, 5, 2);
        addNumericValidation("layerHeight", 0.1, 0.4, 0.2);
        addNumericValidation("wallThickness", 0.4, 2, 0.8);
        addNumericValidation("topBottomLayers", 1, 5, 2);
        addNumericValidation("printSpeed", 25, 150, 100);
        addNumericValidation("infillPercentage", 0, 100, 20);
      });

      document.getElementById('quantity').addEventListener('change', function() {
        const quantity = parseInt(this.value) || 1;
        let discountPercentage = 0;

        if (quantity > 25) {
          discountPercentage = 15;
        } else if (quantity > 10) {
          discountPercentage = 12.5;
        } else if (quantity > 3) {
          discountPercentage = 2.5;
        }

        document.getElementById('discountPercentage').textContent = discountPercentage + '%';
      });
    </script>

    <div id="printerModal" class="modal">
      <div class="modal-content">
        <button class="close-btn">&times;</button>
        <div class="printer-specs">
          <h3>Modified Ender 3 V2 2020</h3>
          <ul>
            <li>Direct Drive with BLTouch</li>
            <li>
              <=0.15mm tolerence
            </li>
            <li>Uses Klipper on Raspberry PI</li>
            <li>Faster prints with Bed Mesh, Input Shaping & Pressure Advance</li>
            <li>Upgraded fan ducts and belts</li>
            <li>Patterned PEI texture plate</li>
            <li>200x200x220 mm3 Build Volume</li>
            <li>Dual-Z for Z-axis accuracy</li>
          </ul>
        </div>
        <img
          src="printer.jpg"
          alt="Modified Ender 3 V2"
          class="printer-image"
        />
      </div>
    </div>
  </body>
</html>
